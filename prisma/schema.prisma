generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id           String     @id @default(uuid())
  email        String     @unique
  name         String
  passwordHash String     @map("password_hash")
  role         UserRole
  status       UserStatus @default(active)
  createdAt    DateTime   @default(now()) @map("created_at")
  updatedAt    DateTime   @updatedAt @map("updated_at")
  doctor       Doctor?
  patient      Patient?
  receptionist Receptionist?
  cashier      Cashier?
  nurse        Nurse?
  labTech      LabTechnician?
  radiologist  Radiologist?
  pharmacist   Pharmacist?

  @@map("users")
}

model Patient {
  id               String          @id @default(uuid())
  userId           String          @unique @map("user_id")
  patientId        String          @unique @map("patient_id")
  age              Int?
  gender           String?
  phone            String?
  address          String?
  bloodGroup       String?         @map("blood_group")
  allergies        String?
  emergencyContact String?         @map("emergency_contact")
  createdAt        DateTime        @default(now()) @map("created_at")
  updatedAt        DateTime        @updatedAt @map("updated_at")
  appointments     Appointment[]
  medicalRecords   MedicalRecord[]
  user             User            @relation(fields: [userId], references: [id], onDelete: Cascade)
  bills            Bill[]
  ipdAdmissions    IPDAdmission[]
  emergencyCases   EmergencyCase[]
  operations       OperationSchedule[]
  labRequests      LabRequest[]
  radiologyRequests RadiologyRequest[]
  insurancePolicy  InsurancePolicy?

  @@map("patients")
}

model Doctor {
  id             String          @id @default(uuid())
  userId         String          @unique @map("user_id")
  specialization String
  departmentId   String          @map("department_id")
  cabinNumber    String          @map("cabin_number")
  phone          String
  available      Boolean         @default(true)
  consultationFee Float          @default(500.00) @map("consultation_fee")
  biography      String?
  createdAt      DateTime        @default(now()) @map("created_at")
  updatedAt      DateTime        @updatedAt @map("updated_at")
  
  user           User            @relation(fields: [userId], references: [id], onDelete: Cascade)
  department     Department      @relation(fields: [departmentId], references: [id])
  appointments   Appointment[]
  medicalRecords MedicalRecord[]
  bills          Bill[]
  ipdAdmissions  IPDAdmission[]
  operations     OperationSchedule[]
  labRequests    LabRequest[]
  radiologyRequests RadiologyRequest[]

  @@map("doctors")
}

model Department {
  id          String   @id @default(uuid())
  name        String   @unique
  description String?
  floor       Int
  wing        String?
  doctors     Doctor[]
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  @@map("departments")
}

model Appointment {
  id             String            @id @default(uuid())
  patientId      String            @map("patient_id")
  doctorId       String            @map("doctor_id")
  scheduledTime  DateTime          @map("scheduled_time")
  status         AppointmentStatus @default(PENDING)
  reason         String
  urgency        UrgencyLevel      @default(NORMAL)
  createdAt      DateTime          @default(now()) @map("created_at")
  updatedAt      DateTime          @updatedAt @map("updated_at")
  doctor         Doctor            @relation(fields: [doctorId], references: [id], onDelete: Cascade)
  patient        Patient           @relation(fields: [patientId], references: [id], onDelete: Cascade)
  medicalRecords MedicalRecord[]

  @@index([patientId])
  @@index([doctorId])
  @@index([scheduledTime])
  @@map("appointments")
}

model MedicalRecord {
  id            String         @id @default(uuid())
  patientId     String         @map("patient_id")
  doctorId      String         @map("doctor_id")
  appointmentId String?        @map("appointment_id")
  diagnosis     String
  treatment     String
  prescription  String?
  notes         String?
  vitals        Json?
  createdAt     DateTime       @default(now()) @map("created_at")
  appointment   Appointment?   @relation(fields: [appointmentId], references: [id])
  doctor        Doctor         @relation(fields: [doctorId], references: [id], onDelete: Cascade)
  patient       Patient        @relation(fields: [patientId], references: [id], onDelete: Cascade)
  prescriptions Prescription[]
  bill          Bill?

  @@index([patientId])
  @@index([doctorId])
  @@map("medical_records")
}

model Prescription {
  id              String        @id @default(uuid())
  medicalRecordId String        @map("medical_record_id")
  medications     Json
  notes           String?
  createdAt       DateTime      @default(now()) @map("created_at")
  medicalRecord   MedicalRecord @relation(fields: [medicalRecordId], references: [id], onDelete: Cascade)

  @@index([medicalRecordId])
  @@map("prescriptions")
}

model Receptionist {
  id            String    @id @default(uuid())
  userId        String    @unique @map("user_id")
  shiftType     ShiftType @map("shift_type")
  workStartTime String    @map("work_start_time") // HH:mm
  workEndTime   String    @map("work_end_time")   // HH:mm
  isActive      Boolean   @default(true) @map("is_active")
  createdAt     DateTime  @default(now()) @map("created_at")
  updatedAt     DateTime  @updatedAt @map("updated_at")
  user          User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("receptionists")
}

model Cashier {
  id            String    @id @default(uuid())
  userId        String    @unique @map("user_id")
  shiftType     ShiftType @map("shift_type")
  workStartTime String    @map("work_start_time") // HH:mm
  workEndTime   String    @map("work_end_time")   // HH:mm
  isActive      Boolean   @default(true) @map("is_active")
  createdAt     DateTime  @default(now()) @map("created_at")
  updatedAt     DateTime  @updatedAt @map("updated_at")
  user          User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  bills         Bill[]

  @@map("cashiers")
}

model Bill {
  id              String        @id @default(uuid())
  patientId       String        @map("patient_id")
  doctorId        String        @map("doctor_id")
  medicalRecordId String?       @map("medical_record_id") @unique
  cashierId       String?       @map("cashier_id")
  amount          Float
  status          BillStatus    @default(PENDING)
  paymentDate     DateTime?     @map("payment_date")
  createdAt       DateTime      @default(now()) @map("created_at")
  updatedAt       DateTime      @updatedAt @map("updated_at")
  
  patient         Patient       @relation(fields: [patientId], references: [id])
  doctor          Doctor        @relation(fields: [doctorId], references: [id])
  medicalRecord   MedicalRecord? @relation(fields: [medicalRecordId], references: [id])
  cashier         Cashier?      @relation(fields: [cashierId], references: [id])
  insuranceClaim  InsuranceClaim?

  @@index([patientId])
  @@index([doctorId])
  @@index([status])
  @@map("bills")
}

model AuditLog {
  id             String   @id @default(uuid())
  action         String
  actorUserId    String   @map("actor_user_id")
  targetResource String?  @map("target_resource")
  metadata       Json?
  timestamp      DateTime @default(now())

  @@index([actorUserId])
  @@index([timestamp])
  @@map("audit_logs")
}

enum UserRole {
  admin
  doctor
  receptionist
  patient
  cashier
  nurse
  lab_technician
  radiologist
  pharmacist
  insurance_officer
}

model Nurse {
  id            String    @id @default(uuid())
  userId        String    @unique @map("user_id")
  shiftType     ShiftType @map("shift_type")
  workStartTime String    @map("work_start_time")
  workEndTime   String    @map("work_end_time")
  isActive      Boolean   @default(true) @map("is_active")
  createdAt     DateTime  @default(now()) @map("created_at")
  updatedAt     DateTime  @updatedAt @map("updated_at")
  user          User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  @@map("nurses")
}

model LabTechnician {
  id            String    @id @default(uuid())
  userId        String    @unique @map("user_id")
  isActive      Boolean   @default(true) @map("is_active")
  createdAt     DateTime  @default(now()) @map("created_at")
  updatedAt     DateTime  @updatedAt @map("updated_at")
  user          User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("lab_technicians")
}

model Radiologist {
  id            String    @id @default(uuid())
  userId        String    @unique @map("user_id")
  isActive      Boolean   @default(true) @map("is_active")
  createdAt     DateTime  @default(now()) @map("created_at")
  updatedAt     DateTime  @updatedAt @map("updated_at")
  user          User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("radiologists")
}

model Pharmacist {
  id            String    @id @default(uuid())
  userId        String    @unique @map("user_id")
  isActive      Boolean   @default(true) @map("is_active")
  createdAt     DateTime  @default(now()) @map("created_at")
  updatedAt     DateTime  @updatedAt @map("updated_at")
  user          User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("pharmacists")
}

// --- IPD MODULE ---
model Ward {
  id          String   @id @default(uuid())
  name        String   @unique
  type        String   // General, ICU, Private
  floor       Int
  gender      String?  // MALE, FEMALE, MIXED
  capacity    Int
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")
  beds        Bed[]

  @@map("wards")
}

model Bed {
  id            String        @id @default(uuid())
  wardId        String        @map("ward_id")
  bedNumber     String        @map("bed_number")
  status        BedStatus     @default(AVAILABLE)
  createdAt     DateTime      @default(now()) @map("created_at")
  updatedAt     DateTime      @updatedAt @map("updated_at")
  ward          Ward          @relation(fields: [wardId], references: [id])
  admission     IPDAdmission?

  @@unique([wardId, bedNumber])
  @@map("beds")
}

model IPDAdmission {
  id            String          @id @default(uuid())
  patientId     String          @map("patient_id")
  doctorId      String          @map("doctor_id")
  bedId         String          @unique @map("bed_id")
  admissionDate DateTime        @default(now()) @map("admission_date")
  dischargeDate DateTime?       @map("discharge_date")
  diagnosis     String?
  status        AdmissionStatus @default(ADMITTED)
  notes         String?
  createdAt     DateTime        @default(now()) @map("created_at")
  updatedAt     DateTime        @updatedAt @map("updated_at")
  
  patient       Patient         @relation(fields: [patientId], references: [id])
  doctor        Doctor          @relation(fields: [doctorId], references: [id])
  bed           Bed             @relation(fields: [bedId], references: [id])

  @@map("ipd_admissions")
}

// --- EMERGENCY MODULE ---
model EmergencyCase {
  id            String        @id @default(uuid())
  patientId     String?       @map("patient_id") // Optional if patient created later
  patientName   String?       // For quick registration
  careProviderId String?      @map("care_provider_id") // Doctor or Nurse
  triageLevel   TriageLevel   @default(NORMAL)
  status        EmergencyStatus @default(TRIAGE)
  symptoms      String
  notes         String?
  createdAt     DateTime      @default(now()) @map("created_at")
  updatedAt     DateTime      @updatedAt @map("updated_at")
  
  patient       Patient?      @relation(fields: [patientId], references: [id])

  @@map("emergency_cases")
}

// --- OT MODULE ---
model OperationSchedule {
  id            String           @id @default(uuid())
  patientId     String           @map("patient_id")
  doctorId      String           @map("doctor_id") // Surgeon
  theaterName   String           @map("theater_name")
  procedureName String           @map("procedure_name")
  startTime     DateTime         @map("start_time")
  endTime       DateTime         @map("end_time")
  status        OperationStatus  @default(SCHEDULED)
  notes         String?
  createdAt     DateTime         @default(now()) @map("created_at")
  updatedAt     DateTime         @updatedAt @map("updated_at")

  patient       Patient          @relation(fields: [patientId], references: [id])
  doctor        Doctor           @relation(fields: [doctorId], references: [id])

  @@map("operation_schedules")
}

// --- LAB MODULE ---
model LabTest {
  id          String   @id @default(uuid())
  name        String   @unique
  code        String   @unique
  category    String   // Hematology, Biochemistry, etc.
  price       Float
  normalRange String?  @map("normal_range")
  units       String?
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")
  requests    LabRequest[]

  @@map("lab_tests")
}

model LabRequest {
  id            String       @id @default(uuid())
  patientId     String       @map("patient_id")
  doctorId      String       @map("doctor_id")
  testId        String       @map("test_id")
  status        LabStatus    @default(PENDING)
  resultValue   String?      @map("result_value")
  resultFileUrl String?      @map("result_file_url")
  notes         String?
  requestedAt   DateTime     @default(now()) @map("requested_at")
  completedAt   DateTime?    @map("completed_at")
  
  patient       Patient      @relation(fields: [patientId], references: [id])
  doctor        Doctor       @relation(fields: [doctorId], references: [id])
  test          LabTest      @relation(fields: [testId], references: [id])

  @@map("lab_requests")
}

// --- RADIOLOGY MODULE ---
model RadiologyRequest {
  id            String           @id @default(uuid())
  patientId     String           @map("patient_id")
  doctorId      String           @map("doctor_id")
  testType      RadiologyTestType @map("test_type")
  bodyPart      String           @map("body_part")
  status        RadiologyStatus  @default(PENDING)
  imageUrl      String?          @map("image_url")
  reportUrl     String?          @map("report_url")
  findings      String?
  requestedAt   DateTime         @default(now()) @map("requested_at")
  completedAt   DateTime?        @map("completed_at")
  
  patient       Patient          @relation(fields: [patientId], references: [id])
  doctor        Doctor           @relation(fields: [doctorId], references: [id])

  @@map("radiology_requests")
}

// --- PHARMACY MODULE ---
model PharmacyInventory {
  id          String   @id @default(uuid())
  name        String
  category    String?
  stock       Int
  unitPrice   Float    @map("unit_price")
  batchNumber String?  @map("batch_number")
  expiryDate  DateTime? @map("expiry_date")
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  @@map("pharmacy_inventory")
}

// --- INSURANCE MODULE ---
model InsurancePolicy {
  id             String    @id @default(uuid())
  patientId      String    @unique @map("patient_id")
  providerName   String    @map("provider_name")
  policyNumber   String    @unique @map("policy_number")
  coverageAmount Float     @map("coverage_amount")
  validFrom      DateTime  @map("valid_from")
  validTill      DateTime  @map("valid_till")
  createdAt      DateTime  @default(now()) @map("created_at")
  updatedAt      DateTime  @updatedAt @map("updated_at")
  
  patient        Patient   @relation(fields: [patientId], references: [id])
  claims         InsuranceClaim[]

  @@map("insurance_policies")
}

model InsuranceClaim {
  id            String       @id @default(uuid())
  policyId      String       @map("policy_id")
  billId        String       @unique @map("bill_id")
  amount        Float
  status        ClaimStatus  @default(SUBMITTED)
  notes         String?
  createdAt     DateTime     @default(now()) @map("created_at")
  updatedAt     DateTime     @updatedAt @map("updated_at")

  policy        InsurancePolicy @relation(fields: [policyId], references: [id])
  bill          Bill            @relation(fields: [billId], references: [id])

  @@map("insurance_claims")
}

enum UserStatus {
  active
  inactive
}

enum AppointmentStatus {
  PENDING
  CONFIRMED
  COMPLETED
  CANCELLED
}

enum UrgencyLevel {
  NORMAL
  HIGH
}

enum ShiftType {
  DAY
  NIGHT
}

enum BillStatus {
  PENDING
  PAID
  CANCELLED
}

enum BedStatus {
  AVAILABLE
  OCCUPIED
  MAINTENANCE
  CLEANING
}

enum AdmissionStatus {
  ADMITTED
  DISCHARGED
}

enum TriageLevel {
  CRITICAL
  MODERATE
  NORMAL
}

enum EmergencyStatus {
  TRIAGE
  TREATMENT
  ADMITTED
  DISCHARGED
}

enum OperationStatus {
  SCHEDULED
  IN_PROGRESS
  COMPLETED
  CANCELLED
}

enum LabStatus {
  PENDING
  IN_PROGRESS
  COMPLETED
  CANCELLED
}

enum RadiologyTestType {
  XRAY
  CT
  MRI
  ULTRASOUND
}

enum RadiologyStatus {
  PENDING
  COMPLETED
  CANCELLED
}

enum ClaimStatus {
  SUBMITTED
  APPROVED
  REJECTED
  PAID
}
